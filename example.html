<!DOCTYPE html>
<html>
    <head>
        <title>tinymidipcm</title>
    </head>
    <body>
        <script src="https://unpkg.com/pcm-player"></script>

        <script src="/webaudio-test.js"></script>

        <script type="module">
            import TinyMidiPCM from './index.js';

            (async () => {
                const tinyMidiPCM = new TinyMidiPCM({
                    renderInterval: 800,
                });

                tinyMidiPCM.setBufferDuration(2);
                await tinyMidiPCM.init();

                const soundfontRes = await fetch('/gm.sf2');

                const soundfontBuffer = new Uint8Array(
                    await soundfontRes.arrayBuffer()
                );

                tinyMidiPCM.setSoundfont(soundfontBuffer);

                const midiRes = await fetch('/runescape-flute salad.mid');
                const midiBuffer = new Uint8Array(await midiRes.arrayBuffer());

                window.onclick = () => {
                    const player = new PCMPlayer({
                        inputCodec: 'Float32',
                        channels: 2,
                        sampleRate: 44100,
                        onended: () => {
                            console.log('end', player.audioCtx);
                        },
                        onstatechange: (test) => {
                            console.log(test);
                        },
                        flushTime: 1000,
                    });

                    tinyMidiPCM.render(midiBuffer, (test) => {
                        console.log(test);
                        player.feed(test);
                    });
                };
            })();
        </script>
    </body>
</html>
